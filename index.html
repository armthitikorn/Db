<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Dashboard: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á Roleplay (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö Feedback ‡πÅ‡∏•‡∏∞ Report)</title>
    
    <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* 1. Base Styles */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            background-color: #f4f7f6;
            color: #333;
        }
        .container-box {
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        h1 { 
            font-size: 36px;
            color: #d9534f;
            margin-bottom: 25px;
            text-align: center;
        }
        h2 { 
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        
        /* 2. Controls & Filters */
        .filter-control {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f8f8;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-control label {
            font-weight: bold;
            color: #555;
            min-width: 70px;
        }
        .filter-control select, .filter-control input[type="text"], .filter-control input[type="date"] {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 16px;
            min-width: 150px;
        }
        .apply-btn {
            padding: 8px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .apply-btn:hover { background-color: #218838; }
        #exportReportBtn {
            background-color: #007bff;
            margin-left: auto; /* Push to the right */
        }
        #exportReportBtn:hover { background-color: #0056b3; }

        /* 3. User List (Sidebar Style) */
        #userList {
            max-height: 70vh;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            padding-right: 15px;
        }
        .user-card {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            border-left: 5px solid #ccc;
        }
        .user-card:hover {
            background-color: #e9ecef;
            border-left-color: #337ab7;
        }
        .user-card.active {
            background-color: #d1ecf1;
            border-left-color: #007bff;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }
        .card-type {
            display: inline-block;
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 4px;
            background-color: #d9534f;
            color: white;
            margin-left: 10px;
        }

        /* 4. Session Details */
        #sessionDetails {
            padding-left: 25px;
            min-height: 500px; 
        }
        .turn-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
        }
        .turn-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #d9534f;
        }
        .audio-pair {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .audio-block {
            flex: 1;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 6px;
        }
        .audio-block label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .customer-audio { border-color: #5cb85c; background-color: #f0fff0; }
        .employee-audio { border-color: #337ab7; background-color: #f5faff; }
        /* Style for AI Feedback Section */
        .ai-feedback {
            margin-top: 10px; 
            padding: 10px; 
            background-color: #e0f2f1; /* Light Teal/Cyan for AI */
            border-radius: 6px;
            border: 1px solid #00796b;
            font-size: 0.9em;
        }

        /* 5. Audio Player (Button/Placeholder) */
        /* üö® FIX: Make the click area clearly look clickable */
        .audio-placeholder {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
            color: #337ab7;
        }
        .audio-placeholder:hover {
            background-color: #dee2e6;
            color: #0056b3;
        }
        .audio-player-active {
            width: 100%;
            height: 30px;
        }
        
        /* 6. Feedback Form */
        #feedbackSection {
            background-color: #f7f7f7;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #ccc;
        }
        #feedbackForm input[type="text"], #feedbackForm textarea {
            width: 98%;
        }

        /* 7. Layout (Flexbox) */
        .dashboard-layout {
            display: flex;
            gap: 20px;
        }
        .col-3 { flex: 0 0 300px; } 
        .col-9 { flex: 1; } 
    </style>
</head>
<body>
    
    <div class="container-box">
        <h1>Dashboard: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á Roleplay (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö Feedback ‡πÅ‡∏•‡∏∞ Report)</h1>
        
        <div class="filter-control">
            <div class="filter-group">
                <label for="traineeNameFilter">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                <input type="text" id="traineeNameFilter" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠...">
            </div>

            <div class="filter-group">
                <label for="trainerNameFilter">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå:</label>
                <input type="text" id="trainerNameFilter" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå...">
            </div>

            <div class="filter-group">
                <label for="insuranceFilter">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô:</label>
                <select id="insuranceFilter">
                    <option value="All">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="Health">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
                    <option value="Life">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
                    <option value="Retirement">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç</option> 
                </select>
            </div>
            
            <div class="filter-group">
                <label for="groupFilter">‡∏Å‡∏•‡∏∏‡πà‡∏°:</label>
                <input type="text" id="groupFilter" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°...">
            </div>
            
            <div class="filter-group">
                <label for="startDateFilter">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
                <input type="date" id="startDateFilter">
            </div>
            <div class="filter-group">
                <label for="endDateFilter">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                <input type="date" id="endDateFilter">
            </div>

            <button class="apply-btn" id="applyFilterBtn">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="apply-btn" id="exportReportBtn">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Report (.csv)</button>
        </div>

        <div class="dashboard-layout">
            
            <div class="col-3">
                <h2>üë§ ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
                <div id="loadingIndicator" class="alert alert-info" style="display: none;">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö...
                </div>
                <div id="userList">
                    <p class="alert alert-info">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    </p>
                </div>
            </div>
            
            <div class="col-9">
                <h2 id="sessionHeader">üéØ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Turn ‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö</h2>

                <div id="feedbackSection" style="display: none;">
                    <h3>üìù ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡πÇ‡∏î‡∏¢‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</h3>
                    <form id="feedbackForm">
                        <input type="hidden" id="feedbackUserId">
                        <label for="trainerNameInput">1. ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</label>
                        <input type="text" id="trainerNameInput" required>

                        <label for="overallScoreInput">2. ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ):</label>
                        <input type="text" id="overallScoreInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 90/100, ‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå">
                        
                        <label for="passCriteriaInput">3. ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Part:</label>
                        <textarea id="passCriteriaInput" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á (‡πÄ‡∏ä‡πà‡∏ô S1: 5/5, S2: 8/10)"></textarea>

                        <label for="trainerCommentsInput">4. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå (Feedback):</label>
                        <textarea id="trainerCommentsInput" rows="4" required></textarea>

                        <button type="submit" id="saveFeedbackBtn">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
                    </form>
                    <p id="feedbackStatus" class="mt-3 alert alert-info" style="display:none;"></p>
                </div>
                
                <div id="sessionDetails">
                    <p class="alert alert-info text-center">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                    </p>
                </div>
            </div>
            
        </div>
        
    </div>

<script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // --- 1. Supabase Configuration ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- DOM Elements ---
        const userListElement = document.getElementById('userList');
        const sessionDetailsElement = document.getElementById('sessionDetails');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const insuranceFilter = document.getElementById('insuranceFilter');
        const traineeNameFilter = document.getElementById('traineeNameFilter');
        const trainerNameFilter = document.getElementById('trainerNameFilter');
        const groupFilter = document.getElementById('groupFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const applyFilterBtn = document.getElementById('applyFilterBtn');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const feedbackSection = document.getElementById('feedbackSection');
        const feedbackForm = document.getElementById('feedbackForm');
        const feedbackUserId = document.getElementById('feedbackUserId');
        const trainerNameInput = document.getElementById('trainerNameInput');
        const overallScoreInput = document.getElementById('overallScoreInput');
        const passCriteriaInput = document.getElementById('passCriteriaInput');
        const trainerCommentsInput = document.getElementById('trainerCommentsInput');
        const feedbackStatus = document.getElementById('feedbackStatus');
        
        let allUsersData = []; 

        // --- Helper Function: Format Date to YYYY-MM-DD ---
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        // --- Initialization of Default Dates (30 days back to today) ---
        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            // Set input values
            endDateFilter.value = formatDate(today);
            startDateFilter.value = formatDate(thirtyDaysAgo);
        }

        // --- 2. Data Fetching and Filtering Functions ---

        async function fetchUsers() {
            loadingIndicator.style.display = 'block';
            userListElement.innerHTML = '';
            
            // 1. Fetch all submissions
            const { data: allSubmissions, error: subError } = await supabase
                .from('submissions')
                .select('user_id, name, user_group, created_at, insurance_type'); 

            // 2. Fetch all trainer feedback
            const { data: allFeedback, error: fbError } = await supabase
                .from('trainer_feedback') 
                .select('*');
            
            if (subError || fbError) {
                console.error("Error fetching data:", subError || fbError);
                loadingIndicator.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'trainer_feedback' ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'insurance_type' ‡πÅ‡∏•‡πâ‡∏ß`;
                loadingIndicator.style.display = 'block';
                return;
            }

            // Map feedback by user_id
            const feedbackMap = new Map();
            allFeedback.forEach(fb => feedbackMap.set(fb.user_id, fb));

            // Group submissions by user_id and merge with feedback (get latest submission only)
            const usersMap = {};
            allSubmissions.forEach(submission => {
                const { user_id, name, user_group, created_at, insurance_type } = submission;
                
                if (!usersMap[user_id] || new Date(created_at) > new Date(usersMap[user_id].latest_submission)) {
                    usersMap[user_id] = {
                        user_id,
                        name: name || 'Anon User',
                        user_group: user_group || 'N/A',
                        latest_submission: created_at,
                        insurance_type: insurance_type || 'Unknown',
                        feedback: feedbackMap.get(user_id) || null 
                    };
                }
            });

            allUsersData = Object.values(usersMap).sort((a, b) => new Date(b.latest_submission) - new Date(a.latest_submission));
            
            // Apply current filters
            renderUserList(applyFilters(allUsersData));
            loadingIndicator.style.display = 'none';
        }

        // üö® Final Fix: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô applyFilters (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Timezone ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Date.UTC ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î)
        function applyFilters(users) {
            const traineeName = traineeNameFilter.value.toLowerCase();
            const trainerName = trainerNameFilter.value.toLowerCase();
            const insuranceType = insuranceFilter.value;
            const group = groupFilter.value.toLowerCase();
            
            const startDateStr = startDateFilter.value; // Expected: YYYY-MM-DD
            const endDateStr = endDateFilter.value;     // Expected: YYYY-MM-DD

            return users.filter(user => {
                // 1-4. Other filters remain the same
                if (traineeName && !user.name.toLowerCase().includes(traineeName)) return false;
                if (trainerName && (!user.feedback || !user.feedback.trainer_name || !user.feedback.trainer_name.toLowerCase().includes(trainerName))) return false;
                if (insuranceType !== 'All' && user.insurance_type !== insuranceType) return false;
                if (group && !user.user_group.toLowerCase().includes(group)) return false;

                // 5. Date/Time Filtering (FIXED: Use UTC Date Interpretation for comparison)
                
                // createdDate: Date object ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å String ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô Supabase (‡πÄ‡∏õ‡πá‡∏ô UTC Time)
                const createdDate = new Date(user.latest_submission);
                
                if (startDateStr) {
                    const [year, month, day] = startDateStr.split('-').map(Number);
                    // üö® ‡∏´‡∏°‡∏±‡∏î‡∏ô‡πá‡∏≠‡∏Ñ: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 00:00:00 ‡πÉ‡∏ô UTC ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                    const startTimeUTC = Date.UTC(year, month - 1, day, 0, 0, 0, 0); 
                    const startDate = new Date(startTimeUTC); 

                    if (createdDate < startDate) return false;
                }

                if (endDateStr) {
                    const [year, month, day] = endDateStr.split('-').map(Number);
                    // üö® ‡∏´‡∏°‡∏±‡∏î‡∏ô‡πá‡∏≠‡∏Ñ: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î 23:59:59.999 ‡πÉ‡∏ô UTC ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                    const endTimeUTC = Date.UTC(year, month - 1, day, 23, 59, 59, 999);
                    const endDate = new Date(endTimeUTC);
                    
                    if (createdDate > endDate) return false;
                }
                
                return true;
            });
        }

        async function fetchTurns(userId, user) {
            feedbackSection.style.display = 'block'; 
            sessionDetailsElement.innerHTML = '<p class="alert alert-info text-center mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...</p>';
            
            // 1. Populate Feedback Form
            populateFeedbackForm(userId, user.feedback);

            // 2. Fetch Turn Details
            const { data: turns, error } = await supabase
                .from('submissions')
                .select('*')
                .eq('user_id', userId)
                .order('part_number', { ascending: true })
                .order('question_number', { ascending: true });

            if (error) {
                sessionDetailsElement.innerHTML = `<p class="alert alert-danger text-center mt-3">‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Turn: ${error.message}</p>`;
                return;
            }

            renderSessionDetails(turns);
        }

        // --- 3. Rendering and Interaction Functions ---

        function renderUserList(users) {
            userListElement.innerHTML = '';
            if (users.length === 0) {
                userListElement.innerHTML = '<p class="alert alert-warning">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                return;
            }

            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';
                if (user.feedback) {
                    card.style.borderLeftColor = '#007bff'; 
                    card.title = `‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢: ${user.feedback.trainer_name}`;
                } else {
                    card.style.borderLeftColor = '#dc3545'; 
                    card.title = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô`;
                }
                
                card.innerHTML = `
                    <div><strong>${user.name}</strong> <span class="card-type">${user.insurance_type}</span></div>
                    <small>‡∏Å‡∏•‡∏∏‡πà‡∏°: ${user.user_group}</small>
                    <small>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(user.latest_submission).toLocaleDateString('th-TH')}</small>
                `;
                card.onclick = () => {
                    document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    fetchTurns(user.user_id, user);
                };
                userListElement.appendChild(card);
            });
        }
        
        function getPartName(part) {
            switch (part) {
                case 1: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢";
                case 15: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitch)";
                case 2: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
                case 3: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á";
                case 4: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
                case 5: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
                default: return `Part ${part}`;
            }
        }
        
        function getQuestionDisplay(part, qNum) {
            if (part === 15) return `S1.5 Pitch`;
            if (part === 3 && qNum === 0) return `S3: Script ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢`;
            if (part === 4 && qNum > 10) { 
                return `S4: ‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q1.F${qNum % 10}`;
            }
            if (part === 4) return `S4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å Q${qNum}`;
            
            return `Q${qNum}`;
        }
        
        function createAudioPlayer(element, url) {
            if (!url) return;
            element.innerHTML = '';
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.className = 'audio-player-active';
            audio.src = url;
            element.appendChild(audio);
        }

        function renderSessionDetails(turns) {
            sessionDetailsElement.innerHTML = ''; 
            
            if (turns.length === 0) {
                sessionDetailsElement.innerHTML = '<p class="alert alert-warning text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö Turn ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            turns.forEach((turn, index) => {
                const partName = getPartName(turn.part_number);
                const qDisplay = getQuestionDisplay(turn.part_number, turn.question_number);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 'http' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Placeholder
                const isCustomerAudioUrl = turn.customer_audio_url && turn.customer_audio_url.startsWith('http');
                const customerAudioUrl = isCustomerAudioUrl ? turn.customer_audio_url : null;
                const employeeAudioUrl = turn.audio_url || null;
                
                // *** ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: AI Scoring/Comment ***
                const aiFeedbackHtml = (turn.ai_score || turn.ai_comment) 
                    ? `
                        <div class="ai-feedback">
                            <strong>ü§ñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å AI:</strong> 
                            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${turn.ai_score || 'N/A'}</span>
                            <p style="margin-top: 5px; margin-bottom: 0;">
                                <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô:</strong> ${turn.ai_comment || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI'}
                            </p>
                        </div>
                      `
                    : '';
                // ***************************************

                const turnItem = document.createElement('div');
                turnItem.className = 'turn-item';
                turnItem.innerHTML = `
                    <div class="turn-header">
                        [Turn ${index + 1}] ${partName} - ${qDisplay}
                    </div>
                    <div>
                        <small><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${turn.question_text || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</small>
                    </div>
                    
                    ${aiFeedbackHtml} 
                    
                    <div class="audio-pair mt-3">
                        
                        <div class="audio-block customer-audio">
                            <label>üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)</label>
                            ${customerAudioUrl
                                ? `<div style="display: flex; gap: 5px; align-items: center;">
                                     <div class="audio-placeholder" data-url="${customerAudioUrl}" data-role="customer" style="flex-grow: 1;">
                                         ‚ñ∂Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                                     </div>
                                     <a href="${customerAudioUrl}" download="Customer_P${turn.part_number}_Q${turn.question_number}.webm" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" style="font-size: 1.5em; text-decoration: none; color: #5cb85c;">‚¨áÔ∏è</a>
                                   </div>`
                                : `<p class="alert alert-warning small mb-0">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${turn.customer_audio_url || 'N/A'})</p>`
                            }
                        </div>
                        
                        <div class="audio-block employee-audio">
                            <label>üé§ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö/Script)</label>
                            ${employeeAudioUrl
                                ? `<div style="display: flex; gap: 5px; align-items: center;">
                                     <div class="audio-placeholder" data-url="${employeeAudioUrl}" data-role="employee" style="flex-grow: 1;">
                                         ‚ñ∂Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                                     </div>
                                     <a href="${employeeAudioUrl}" download="Employee_P${turn.part_number}_Q${turn.question_number}.webm" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" style="font-size: 1.5em; text-decoration: none; color: #337ab7;">‚¨áÔ∏è</a>
                                   </div>`
                                : `<p class="alert alert-danger small mb-0">‚ùå URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>`
                            }
                        </div>
                        
                    </div>
                `;
                sessionDetailsElement.appendChild(turnItem);
            });
            
            document.querySelectorAll('.audio-placeholder').forEach(placeholder => {
                placeholder.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    
                    if (url && !this.querySelector('audio')) { 
                        createAudioPlayer(this, url);
                    }
                });
            });
        }

        function populateFeedbackForm(userId, feedback) {
            feedbackUserId.value = userId;
            trainerNameInput.value = feedback ? feedback.trainer_name || '' : '';
            overallScoreInput.value = feedback ? feedback.score_section_overall || '' : '';
            passCriteriaInput.value = feedback ? feedback.pass_criteria || '' : '';
            trainerCommentsInput.value = feedback ? feedback.trainer_comments || '' : '';
            
            saveFeedbackBtn.textContent = feedback ? 'üìù ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' : '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
            feedbackStatus.style.display = 'none';
        }
        
        // --- 4. Trainer Feedback Submission ---

        feedbackForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = feedbackUserId.value;
            const trainee = allUsersData.find(u => u.user_id === userId);
            
            if (!trainee) {
                feedbackStatus.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                feedbackStatus.style.display = 'block';
                return;
            }

            const feedbackData = {
                user_id: userId,
                trainee_name: trainee.name, 
                trainer_name: trainerNameInput.value.trim(),
                score_section_overall: overallScoreInput.value.trim(),
                pass_criteria: passCriteriaInput.value.trim(),
                trainer_comments: trainerCommentsInput.value.trim(),
            };

            const existingFeedback = trainee.feedback;
            let error;

            if (existingFeedback) {
                const { error: updateError } = await supabase
                    .from('trainer_feedback')
                    .update(feedbackData)
                    .eq('user_id', userId);
                error = updateError;
            } else {
                const { error: insertError } = await supabase
                    .from('trainer_feedback')
                    .insert([feedbackData]);
                error = insertError;
            }

            feedbackStatus.style.display = 'block';
            if (error) {
                feedbackStatus.className = 'mt-3 alert alert-danger';
                feedbackStatus.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
            } else {
                feedbackStatus.className = 'mt-3 alert alert-success';
                feedbackStatus.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${trainee.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!`;
                
                await fetchUsers();
                document.querySelector(`.user-card.active`)?.classList.remove('active');
                document.querySelectorAll('.user-card').forEach(c => {
                    if (c.textContent.includes(trainee.name)) c.classList.add('active');
                });
            }
        });

        // --- 5. Report Export (CSV/Excel) ---

        exportReportBtn.addEventListener('click', function() {
            const filteredUsers = applyFilters(allUsersData);
            if (filteredUsers.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô.");
                return;
            }

            const csvData = [];
            
            // Report Header
            csvData.push([
                "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå", 
                "‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", 
                "‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô",
                "‡∏Å‡∏•‡∏∏‡πà‡∏°",
                "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö", 
                "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏™‡∏£‡∏∏‡∏õ)",
                "‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á (‡πÇ‡∏î‡∏¢‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå)",
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå (Feedback)"
            ]);

            // Report Body
            filteredUsers.forEach(user => {
                const fb = user.feedback || {};
                csvData.push([
                    fb.trainer_name || 'N/A (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô)',
                    user.name,
                    user.insurance_type,
                    user.user_group,
                    new Date(user.latest_submission).toLocaleDateString('th-TH') + ' ' + new Date(user.latest_submission).toLocaleTimeString('th-TH'),
                    fb.score_section_overall || 'N/A',
                    fb.pass_criteria || 'N/A',
                    fb.trainer_comments || 'N/A'
                ]);
            });

            // Convert array to CSV string
            const csvContent = csvData.map(e => e.map(item => `"${item.toString().replace(/"/g, '""')}"`).join(",")).join("\n");
            
            // Trigger download using FileSaver 
            const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" }); 
            saveAs(blob, `Roleplay_Report_${new Date().toISOString().slice(0, 10)}.csv`);
        });

        // --- 6. Initialization ---

        // 1. Apply button triggers data fetch and filtering
        applyFilterBtn.addEventListener('click', fetchUsers);
        
        // 2. Set default date ranges (30 days ago to today)
        document.addEventListener('DOMContentLoaded', setDefaultDates); 
        
        // 3. (IMPORTANT) The page will not fetch data until the user clicks '‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
        
    </script>
</body>
</html>
